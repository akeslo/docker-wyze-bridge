# Troubleshooting Guide

## Common Errors and Solutions

### TURN Server Errors

#### Symptoms
```
turnc ERROR: Fail to refresh permissions: all retransmissions failed
turnc ERROR: Fail to refresh permissions: write tcp4 ... write: broken pipe
```

#### Explanation
These errors are generated by go2rtc's internal TURN client during WebRTC connection management. TURN (Traversal Using Relays around NAT) servers help establish connections through firewalls and NATs.

#### When These Errors Are Expected
- **Transient network issues**: Brief network disruptions that resolve automatically
- **ICE negotiation**: During the connection negotiation phase, multiple connection attempts are made
- **Credential refresh**: TURN credentials have a limited lifetime and may fail to refresh occasionally
- **Load balancing**: Wyze's TURN servers may redirect or drop connections during normal operation

#### Impact
**In most cases, these errors do NOT affect functionality.** The system will:
- Automatically retry failed connections
- Use alternative ICE candidates (STUN, direct connections)
- Continue streaming even with occasional TURN failures

#### When to Investigate
Only investigate if you experience:
- Complete loss of video streams
- Inability to connect to cameras
- Persistent connection failures (all cameras affected)

#### Solutions
1. **Check network connectivity**: Ensure your Docker host can reach external TURN servers (AWS IP ranges)
2. **Verify firewall rules**: TURN uses TCP/UDP ports 443 and other high ports
3. **Monitor ICE connection state**: Look for "ICE connection failed" messages in logs
4. **Restart if persistent**: If errors persist for >10 minutes, restart the container

---

### Thumbnail 401 Authentication Errors

#### Symptoms
```
[API] Error pulling thumbnail: [HTTPError] 401 Client Error: for url: https://prod-sight-safe-auth.wyze.com/...
```

#### Explanation
Wyze's thumbnail URLs are signed with temporary credentials that expire after a certain time. If a cached URL is used after expiration, a 401 error occurs.

#### Solution
**Fixed in recent update**: The system now automatically:
1. Detects 401 errors when fetching thumbnails
2. Refreshes camera data to get a new signed URL
3. Retries the thumbnail fetch with fresh credentials

#### Manual Workaround
If thumbnails still fail to load:
1. Go to the web UI
2. Click "Restart Cameras" to refresh all camera data
3. Thumbnails should reload with fresh URLs

---

### WebRTC Connection Troubleshooting

#### Checking Connection Status
Monitor logs for ICE connection state changes:
```
[camera-name] ICE state: checking - Negotiating connection
[camera-name] ICE state: connected - Successfully connected
[camera-name] ICE state: disconnected - Temporary disconnection
[camera-name] ICE state: failed - Connection failed, will retry
```

#### Connection States
- **checking**: Normal - negotiating connection paths
- **connected**: Good - streaming active
- **disconnected**: Warning - may recover automatically
- **failed**: Error - will trigger reconnection with fresh credentials

#### Reconnection Behavior
The system automatically reconnects with:
- Exponential backoff: 2s, 4s, 8s, 16s, 32s, 60s (max)
- Maximum 10 reconnection attempts
- Fresh TURN credentials on each attempt

---

## Debug Mode

Enable detailed logging for troubleshooting:

```yaml
environment:
  - LOG_LEVEL=DEBUG
```

This will show:
- Detailed ICE negotiation logs
- WebRTC signaling messages
- API request/response details
- Connection state transitions

---

## Getting Help

When reporting issues, include:
1. Docker logs showing the error
2. Camera models affected
3. Network topology (firewalls, VLANs, etc.)
4. Duration and frequency of errors
5. Whether streams are actually affected

**Remember**: Occasional TURN errors are normal and expected in WebRTC connections. Only investigate if actual functionality is impaired.
